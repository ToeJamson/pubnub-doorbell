<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.20.2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
</head>
<body>
  <div>Connected to doorbell</div>
  <form>
    <input type="text" id="subscribe_uuid">
    <input type="button" value="Submit" onclick="subscribeToUuid()">
  </form>
  <div>
    <input type="button" value="Ping" id="ping" onclick="publishSampleMessage()">
  </div>
	<div id="myid">My id - <span></span></div>
	<div id="subscribed_to">Subscribed to - <span></span></div>
	<div id="message">
		Message
		<div></div>
	</div>
</body>
<script>

let pubnub, myId
var audio = new Audio('doorbell.mp3');

$(document).ready(function () {

  myId = Math.floor(Math.random()*(10000-100+1)+100);
	$("#myid span").text(myId)

  pubnub = new PubNub({
       publishKey : 'demo',
       subscribeKey : 'demo'
   })
  
  console.log("Subscribing..");
  pubnub.subscribe({
      channels: [`doorbell-${myId}`]
  });

  pubnub.addListener({
    status: function(statusEvent) {
        if (statusEvent.category === "PNConnectedCategory") {
            // publishSampleMessage();
        }
    },
    message: function(message) {
				$("#message div").append('<p>' + message.message + '</p>')
        audio.play();
    }
  })
})

function subscribeToUuid() {
		console.log(`subscribed to ${$("#subscribe_uuid").val()}`)
		$("#subscribed_to span").text($("#subscribe_uuid").val())
}

function publishSampleMessage() {
	let otherid = $("#subscribed_to span").text()
	if (otherid){
		let now = new Date()
		var publishConfig = {
			channel : `doorbell-${otherid}`,
			message : `You got a ping from ${myId} at ${now}`
		}
		pubnub.publish(publishConfig, function(status, response) {
				// console.log(status, response);
		})
	} else {
		alert ("Unable to publish as no user is subscribed yet")
	}
}  
</script>
</html>

